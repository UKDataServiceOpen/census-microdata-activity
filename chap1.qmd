# R code for module activity

## 1- Install and load the main packages


```{r packages}
#### Load the packages if installed; install them if not present 

pkg <- c("tidyverse", 
         "ggplot2", 
         "ggrepel", 
         "patchwork", 
         "gridExtra", 
         "haven",   ### Import Stata and SPSS datasets
         "viridis"  ### colourblind friendly palette
)

for (p in pkg) {
  if (!require(p, character.only = T)) {
    install.packages(p)
    library(p, character.only = T)
  }
}
```

## 2- Load the dataset and make a copy

```{r}

publicmicrodatateachingsample <- read_sav("data/publicmicrodatateachingsample.sav")

census2021teaching <- publicmicrodatateachingsample

```

Important: Remember to change the filepath to your dataset accordingly. 

If the **read_sav** code does not work, you can use the **Import Dataset** button in the RStudio Environment Pane to load the dataset in R.

## 3- Drop unnecessary variables

```{r}
#| eval: false
census2021teaching <- census2021teaching[,c("health_in_general",
                                            "hours_per_week_worked",
                                            "resident_age_7d","sex", 
                                            "ethnic_group_tb_6a",
                                            "approx_social_grade")]

head(census2021teaching)
dim(census2021teaching)
```

::: {.callout-note collapse="true"}

## Click to view results

```{r}
#| echo: false
census2021teaching <- census2021teaching[,c("health_in_general",
                                            "hours_per_week_worked",
                                            "resident_age_7d","sex", 
                                            "ethnic_group_tb_6a",
                                            "approx_social_grade")]

head(census2021teaching)
dim(census2021teaching)
```

:::

## 4- Exploratory analysis

### 4.1- Univariate analysis 

#### 4.1.1 Univariate analysis for health in general and hours worked

##### Frequencies for health in general and hours worked

```{r}
#| eval: false

### Raw values
table(census2021teaching$health_in_general)

### Labelled  values
table(as_factor(census2021teaching$hours_per_week_worked))

```

::: {.callout-note collapse="true"}

## Click to view results

```{r}
#| echo: false

### Raw values
table(census2021teaching$health_in_general)

### Labelled  values
table(as_factor(census2021teaching$hours_per_week_worked))
```

:::

##### Distribution of self-rated health and hours worked


```{r}
#| eval: false

round(
      prop.table(
        table(
          as_factor(census2021teaching$health_in_general
                )
      )
      ) * 100,
      1) 

round(
  prop.table(
    table(
      as_factor(census2021teaching$hours_per_week_worked)
      )
    ) * 100,
  1)

```
::: {.callout-note collapse="true"}

## Click to view results

```{r}
#| echo: false

round(
      prop.table(
        table(
          as_factor(census2021teaching$health_in_general
                )
      )
      ) * 100,
      1) 

round(
  prop.table(
    table(
      as_factor(census2021teaching$hours_per_week_worked)
      )
    ) * 100,
  1)

```

:::

<!-- You can also calculate these frequencies and percentages with appropriate labels. -->

##### Frequencies and percentages with labels for health in general and hours worked


You can also generate pie charts for better visualization

### a) Pie chart for self-rated general health



```{r p1}
#| eval: false

h1<-round(100*
            prop.table(
              table(
                as_factor(census2021teaching$health_in_general)
                )
              ),1
          )

h1_df <- as.data.frame(h1)

names(h1_df) <- c("srh", "pct")

pie(h1_df$pct,
    labels = paste(h1_df$srh, sep = " ", h1_df$pct, "%"),
    cex = 0.7, 
    radius=0.9,
    col = viridis::viridis(length(h1_df$srh)), 
    main = "Self-rated general health")

```
::: {.callout-note collapse="true"}

## Click to view results
```{r p1.2}
#| echo: false

h1<-round(100*
            prop.table(
              table(
                as_factor(census2021teaching$health_in_general)
                )
              ),1
          )

h1_df <- as.data.frame(h1)

names(h1_df) <- c("srh", "pct")

pie(h1_df$pct,
    labels = paste(h1_df$srh, sep = " ", h1_df$pct, "%"),
    cex = 0.7, 
    radius=0.9,
    col = viridis::viridis(length(h1_df$srh)), 
    main = "Self-rated general health")

```

:::

### b) Pie chart for Hours worked

##### b.1) Create a labelled hours worked variable


```{r p2}
#| code-fold: true
#| code-summary: "View output"

h2<-round(100*
            prop.table(
              table(
                as_factor(census2021teaching$hours_per_week_worked))
              ),1
          )

h2_df <- as.data.frame(h2)

names(h2_df) <- c("hpw", "pct")

p2<-pie(h2_df$pct,
    labels = paste(h2_df$hpw, sep = " ", h2_df$pct, "%"),
    cex = 0.7, 
    radius=0.9,
    col = viridis::viridis(length(h2_df$hpw)), 
    main = "Hours worked per week")

```


### 4.1.1.1 Transformation of variable Health in general

Create a new variable called **health_binary** by regrouping health in general in two broader categories: **Good or very good health** and **Poor health**


```{r}

census2021teaching$health_binary <- ifelse(
  census2021teaching$health_in_general %in% c(1, 2), "Good or very good health",
  ifelse(census2021teaching$health_in_general %in% c(3, 4, 5), "Poor health", NA)
)

```

##### Drop rows where health_in_general = -8 (Does not apply)

```{r}

census2021teaching <-census2021teaching %>%
                      filter(health_in_general != -8)

```

##### Check the new variable's distribution

```{r}

table(census2021teaching$health_binary)

```

#####  Create variable **Poor_health** and check its distribution

Code a binary variable that takes 1 for poor health and 0 otherwise. Call this new variable **Poor_health**. This variable will be the explained variable of our regression model.

```{r}

census2021teaching$Poor_health <- ifelse(
  census2021teaching$health_binary == "Poor health", 1,
  ifelse(census2021teaching$health_binary == "Good or very good health", 0, NA)
)

table(census2021teaching$Poor_health)

```

### 4.1.2 Univariate analysis for age, sex, ethnicity, social category 

#### Frequencies and percentages for age, sex, ethnicity, social category 

```{r}

t_a<-table(as_factor(census2021teaching$resident_age_7d))
t_s<-table(as_factor(census2021teaching$sex))
t_e<-table(as_factor(census2021teaching$ethnic_group_tb_6a))
t_g<-table(as_factor(census2021teaching$approx_social_grade))

cbind(t_a,round(prop.table(t_a)*100,1))
cbind(t_s,round(prop.table(t_s)*100,1))
cbind(t_e,round(prop.table(t_e)*100,1))
cbind(t_g,round(prop.table(t_g)*100,1))

```

#### Plot pie chart Age variable

```{r}


t_a.df <- as.data.frame(round(prop.table(t_a)*100,1))
names(t_a.df) <- c("age", "pct")

pie(t_a.df$pct,
    labels = paste(t_a.df$age, sep = " ", t_a.df$pct, "%"),
    cex = 0.7, 
    radius=0.9,
    col = viridis::viridis(length(t_a.df$age)), 
    main = "Distribution of respondents by age")


```

#### Pie chart for Sex variable


```{r}

t_s.df <- as.data.frame(round(prop.table(t_s)*100,1))
names(t_s.df) <- c("sex", "pct")

pie(t_s.df$pct,
    labels = paste(t_s.df$sex, sep = " ", t_s.df$pct, "%"),
    cex = 0.7, 
    radius=0.9,
    col = viridis::viridis(length(t_a.df$age)), 
    main = "Distribution of respondents by sex")


```

#### Histogram for Ethnicity variable

##### a) Recode Ethnicity variable with labels

```{r}

Ethnicity <- census2021teaching %>%
  mutate(Ethnicity_label = factor(ethnic_group_tb_6a, levels = c(1, 2, 3, 4, 5, -8), 
                                  labels = c("Asian", "Black", "Mixed", "White", "Other", "Does not apply"))) %>%
  count(Ethnicity_label, name = "n") %>%
  mutate(prop = n / sum(n),
         label = scales::percent(prop, accuracy = 0.1))

```

##### b) Plot histogram

```{r}

ggplot(Ethnicity, aes(x = Ethnicity_label, y = prop)) +
  geom_col(fill = "chocolate", color = "black", width = 0.3) +
  geom_text(aes(label = label), vjust = -0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Distribution of respondents by Ethnicity", x = "", y = "Percentage") +
  theme_classic()+
  theme(axis.text.x = element_text(size = 12))+
  theme(plot.title = element_text(size = 16, hjust = 0.5))

```

#### Pie chart for variable social class

##### a) Create a labelled social class variable

```{r}

Social_class <- census2021teaching %>%
  mutate(
    Social_class_code = as.integer(as.character(approx_social_grade)),
    Social_class_label = factor(
      Social_class_code,
      levels = c(1, 2, 3, 4, -8),
      labels = c("Higher, intermediate managers", "Supervisory, junior managers", 
                 "Skilled manual", "Semi-skilled, unskilled manual","Not applicable")
    )
  ) %>%
  filter(!is.na(Social_class_label)) %>%
  count(Social_class_label, name = "n") %>%
  mutate(
    pct = round(100 * n / sum(n), 1),
    label = paste0(Social_class_label, " (", pct, "%)")
  )

```

##### b) Plot pie chart

```{r}

ggplot(Social_class, aes(x = "", y = n, fill = Social_class_label)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_label_repel(aes(label = label),
                   position = position_stack(vjust = 0.5),
                   show.legend = FALSE,
                   size = 3) +
  labs(title = "Distribution of respondents by Social class", fill = "Social class") +
  theme_void()+
  scale_fill_brewer(palette = "Pastel2") +
  theme(plot.title = element_text(size = 16, hjust = 1))

```

##### Drop under 16 from the table

```{r}

census2021teaching <- subset(census2021teaching, resident_age_7d != 1)

```

### 4.2- Bivariate analysis 

##### Cross tabulation of Poor_health by hours worked

```{r}

tabulation <- table(census2021teaching$Poor_health, census2021teaching$hours_per_week_worked)
tabulation

```

##### Row percentages

```{r}

prop.table(tabulation, margin = 1) * 100

```

##### Column percentages

```{r}

prop.table(tabulation, margin = 2) * 100

```
#### Chi square test

##### a) Creating cross tabulations to be tested

```{r}

tabulation.health_hours <- table(census2021teaching$Poor_health, census2021teaching$hours_per_week_worked)
tabulation.health_age <- table(census2021teaching$Poor_health, census2021teaching$resident_age_7d)
tabulation.health_sex <- table(census2021teaching$Poor_health, census2021teaching$sex)
tabulation.health_ethnicity <- table(census2021teaching$Poor_health, census2021teaching$ethnic_group_tb_6a)
tabulation.health_classes <- table(census2021teaching$Poor_health, census2021teaching$approx_social_grade)

```

##### b) chi square test on health and our 5 other variables

```{r}

chisq.test(tabulation.health_hours)
chisq.test(tabulation.health_age)
chisq.test(tabulation.health_sex)
chisq.test(tabulation.health_ethnicity)
chisq.test(tabulation.health_classes)

```
## 5 Regression model

### 5.1 Recode variables as factors with labels

```{r}

census2021teaching$hours_per_week_worked <- factor(
  census2021teaching$hours_per_week_worked,
  levels = c(1, 2, 3, 4, -8),
  labels = c("0-15", "16-30", "31-48", "49+", "Does not apply")
)

census2021teaching$resident_age_7d <- factor(
  census2021teaching$resident_age_7d,
  levels = c(1, 2, 3, 4, 5, 6, 7, -8),
  labels = c("0-15", "16-24", "25-34", "35-44", "45-54", "55-64", "65+", "Not applicable")
)

census2021teaching$ethnic_group_tb_6a <- factor(
  census2021teaching$ethnic_group_tb_6a,
  levels = c(1, 2, 3, 4, 5, -8),
  labels = c("Asian", "Black", "Mixed", "White", "Other", "Does not apply")
)

census2021teaching$approx_social_grade <- factor(
  census2021teaching$approx_social_grade,
  levels = c(1, 2, 3, 4, -8),
  labels = c("Higher, intermediate managers",
             "Supervisory, junior managers",
             "Skilled manual",
             "Semi-skilled, unskilled manual",
             "Not applicable")
)

census2021teaching$sex <- factor(
  census2021teaching$sex,
  levels = c(1, 2),
  labels = c("Male", "Female")
)

```

### 5.2 Pick references that are central or policy relevant

```{r}

census2021teaching$hours_per_week_worked <- relevel(census2021teaching$hours_per_week_worked, ref = "31-48")
census2021teaching$resident_age_7d         <- relevel(census2021teaching$resident_age_7d,         ref = "45-54")
census2021teaching$sex                  <- relevel(census2021teaching$sex,                  ref = "Male")
census2021teaching$ethnic_group_tb_6a            <- relevel(census2021teaching$ethnic_group_tb_6a,            ref = "White")
census2021teaching$approx_social_grade         <- relevel(census2021teaching$approx_social_grade,         ref = "Higher, intermediate managers")

```

### 5.3 Fit logistic regression 


```{r}

model_health <- glm(
  Poor_health ~ hours_per_week_worked + resident_age_7d + sex + ethnic_group_tb_6a + approx_social_grade,
  data = census2021teaching,
  family = binomial(link = "logit")
)

```
#### Obtain summary results of the logistic regression

```{r}

summary(model_health)

```







